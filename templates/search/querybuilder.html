{% extends "search/base.html" %}    

{% block script %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
 
  <script type="text/javascript">
    $(document).ready(function() {
            $('#btnAdd').click(function() {
                var num     = $('.clonedInput').length; // how many "duplicatable" input fields we currently have
                var newNum  = new Number(num + 1);      // the numeric ID of the new input field being added
 
                // create the new element via clone(), and manipulate it's ID using newNum value
                var newElem = $('#input' + num).clone().attr('id', 'input' + newNum);
               
                newElem.find(':input').attr('id', function(i, val) {
                  return val + newNum;
                });
               
                // insert the new element after the last "duplicatable" input field
                $('#input' + num).after(newElem);
 
                // enable the "remove" button
                $('#btnDel').removeAttr("disabled");
                
                // Maximum number of forms
                if (newNum == 5)
                    $('#btnAdd').attr('disabled','disabled');
                
                $("[id^=from]").change(function() { 				
 				//alert("hello");
 				var idstr = $(this).attr("id")
 				var idarray = idstr.split("_") 				
 				var idnum = idarray[1] 				
 				
 				if ($(this).val() == 'message') {
					$("#where_" + idnum).attr('disabled', true);
					// remove the current where options
				} else {
					var url = "/search/querybuilder/" + $(this).val() + "/all_json_models";
					var from = $(this).val();
					$.getJSON(url, function(where) {
						var options = '<option value="message">Select a filter</option>';
						for (var i = 0; i < where.length; i++) {
							// change phenotype_name to "from_value + name"
							options += '<option value="' + where[i].pk + '">' + where[i].fields['phenotype_name'] + '</option>';
						}
						$("#where_" + idnum).html(options);						
					});
				} 								
			});
        
            });
 
            $('#btnDel').click(function() {
                var num = $('.clonedInput').length; // how many "duplicatable" input fields we currently have
                $('#input' + num).remove();     // remove the last element
 
                // enable the "add" button
                $('#btnAdd').removeAttr("disabled");
 
                // if only one element remains, disable the "remove" button
                if (num-1 == 1)
                    $('#btnDel').attr('disabled','disabled');
            });
 			 		
 			$('#btnAddOut').click(function() {
                var num     = $('.clonedOutput').length; // how many "duplicatable" input fields we currently have
                var newNum  = new Number(num + 1);      // the numeric ID of the new input field being added
 
                // create the new element via clone(), and manipulate it's ID using newNum value
                var newElem = $('#output' + num).clone().attr('id', 'output' + newNum);
               
                // insert the new element after the last "duplicatable" input field
                $('#output' + num).after(newElem);
 
                // enable the "remove" button
                $('#btnDelOut').removeAttr("disabled");
                
                // Maximum number of forms
                if (newNum == 3)
                    $('#btnAddOut').attr('disabled','disabled');
            });
 
            $('#btnDelOut').click(function() {
                var num = $('.clonedOutput').length; // how many "duplicatable" input fields we currently have
                $('#output' + num).remove();     // remove the last element
 
                // enable the "add" button
                $('#btnAddOut').removeAttr("disabled");
 
                // if only one element remains, disable the "remove" button
                if (num-1 == 1)
                    $('#btnDelOut').attr('disabled','disabled');
            });
 			
 			$("[id^=from]").change(function() { 				
 				//alert("hello");
 				var idstr = $(this).attr("id")
 				var idarray = idstr.split("_") 				
 				var idnum = idarray[1] 				
 				
 				if ($(this).val() == 'message') {
					$("#where_" + idnum).attr('disabled', true);
					// remove the current where options
				} else {
					var url = "/search/querybuilder/" + $(this).val() + "/all_json_models";
					var from = $(this).val();
					$.getJSON(url, function(where) {
						var options = '<option value="message">Select a filter</option>';
						for (var i = 0; i < where.length; i++) {
							// change phenotype_name to "from_value + name"
							options += '<option value="' + where[i].pk + '">' + where[i].fields['phenotype_name'] + '</option>';
						}
						$("#where_" + idnum).html(options);						
					});
				} 								
			});
			// change the equals options based on the type of filter
			//$("[id^=where]").change(function() {
 			//	if ($(this).val() == 'message') {					
			//		$("#is").attr('disabled', true);
			//	} else {
			//		$("#is").attr('disabled', false);
			//	} 								
			//});			
 			
            $('#btnDel').attr('disabled','disabled');
            $('#btnDelOut').attr('disabled','disabled');
        });
        // load function once the page has changed
        //$(document).onchange(function() {
        //	alert("onchange");
        //)};
    </script>
{% endblock %}

{% block content %}
  <p class="lead">Build a query:</p>  
  {% if message %}
    <p class="text-error"><em>{{message}}</em></p>
  {% endif %}
  <form class="form-inline" action="" method="post">
    
    {% csrf_token %}      
    
    <div class="row" style="margin-top: 10px;margin-bottom: 10px">
      <div class="span9">
        <div id="input1" class="clonedInput" style="margin-top: 10px;margin-bottom: 10px">
          <select name="from" id="from_12">
            <option value="message">Select a filter type</option>
            <option value="phenotype">Phenotype</option>
            <option value="platform">Platform</option>
            <option value="study">Study</option>
            <option value="qc">QC</option>            
          </select>
          <select name="where" id="where_12">	                  
          </select>
          <select name="is" id="is_1">
            <option value="message"></option>
            <option value="eq">Equals</option>
            <option value="contains">Contains</option>
            <option value="startswith">Starts with</option>
            <option value="endswith">Ends with</option>
            <option value="gt">></option>
            <option value="lt"><</option>
            <option value="gte">>=</option>
            <option value="lte"><=</option>                  
          </select>
          <input type="text" name="querystr" id="querystr_1" />      
        </div>  
      </div>
    </div>
    
    <div class = row style="margin-top: 10px;margin-bottom: 10px">
      <div class="span9">
    	<input type="button" id="btnAdd" value="add another filter" class="btn btn-default btn-success" />
        <input type="button" id="btnDel" value="remove filter" class="btn btn-default btn-danger"/>
       </div> 
    </div> 
       
    <p class="lead" style="margin-top: 20px;margin-bottom: 10px">Output:</p>
    <div class="row" style="margin-top: 10px;margin-bottom: 10px">
      <div class="span9">
        <div id="output1" class="clonedOutput" style="margin-top: 10px;margin-bottom: 10px">
          <select name="select" style="margin-bottom:4px;">
            <option value="message">Select output column</option>
            <option value="individuals">Individual ID</option>
            <option value="source">Individual source</option>
            <option value="samples">Sample ID</option>        
          </select>
        </div>
      </div>
    </div>
    
    <div class = row style="margin-top: 10px;margin-bottom: 10px">
      <div class="span9">
    	<input type="button" id="btnAddOut" value="add another column" class="btn btn-default btn-success" />
        <input type="button" id="btnDelOut" value="remove column" class="btn btn-default btn-danger"/>
      </div>
    </div>
    
    <div class = row style="margin-top: 10px;margin-bottom: 10px">
      <div class="span9">        
        <input type="submit" value="Search" class="btn btn-large btn-primary"/>
      </div>
    </div>
    
  </form> 
{% endblock %}
